# Create a minimal full-stack Next.js (App Router) project for a professional CV platform.
# We'll scaffold files, then zip the project so the user can download it.

import os, json, textwrap, zipfile, pathlib

base = "/mnt/data/cv-platform"
os.makedirs(base, exist_ok=True)

def write(path, content):
    full = os.path.join(base, path)
    os.makedirs(os.path.dirname(full), exist_ok=True)
    with open(full, "w", encoding="utf-8") as f:
        f.write(textwrap.dedent(content).lstrip())

# package.json
write("package.json", """
{
  "name": "cv-platform",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "prisma migrate deploy && next build",
    "start": "next start",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "postinstall": "prisma generate"
  },
  "dependencies": {
    "@prisma/client": "5.17.0",
    "next": "14.2.4",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "zod": "3.23.8",
    "react-hook-form": "7.51.4",
    "next-themes": "0.2.1",
    "lucide-react": "0.452.0",
    "@react-pdf/renderer": "3.4.4",
    "tailwind-merge": "2.4.0"
  },
  "devDependencies": {
    "prisma": "5.17.0",
    "typescript": "5.4.5",
    "autoprefixer": "10.4.19",
    "postcss": "8.4.38",
    "tailwindcss": "3.4.7"
  }
}
""")

# next.config.js
write("next.config.mjs", """
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  experimental: { serverActions: { allowedOrigins: ['*'] } }
};
export default nextConfig;
""")

# tsconfig
write("tsconfig.json", """
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "es2020"],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "baseUrl": "."
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
""")

write("next-env.d.ts", "/// <reference types=\"next\" />\n/// <reference types=\"next/image-types/global\" />\n")

# Tailwind + PostCSS
write("postcss.config.js", """
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
""")

write("tailwind.config.ts", """
import type { Config } from "tailwindcss";

const config: Config = {
  content: ["./src/**/*.{js,ts,jsx,tsx}"],
  theme: { extend: {} },
  plugins: [],
};
export default config;
""")

write("src/app/globals.css", """
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --bg: #0b0f14;
  --card: #10161d;
  --text: #E6EDF3;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
}
.containerish { @apply max-w-5xl mx-auto px-4; }
.btn { @apply inline-flex items-center gap-2 rounded-md px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium; }
.card { @apply rounded-xl border border-white/10 bg-[var(--card)] p-6; }
.input { @apply w-full rounded-md border border-white/10 bg-transparent px-3 py-2 outline-none focus:ring-2 focus:ring-blue-600; }
.label { @apply text-sm text-white/70 mb-1 block; }
.link { @apply underline underline-offset-4 hover:no-underline; }
""")

# Prisma
write("prisma/schema.prisma", """
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  resumes   Resume[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Resume {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  title       String
  fullName    String
  role        String?
  summary     String?
  phone       String?
  email       String?
  location    String?
  skills      String[]
  sections    Section[]
  templateKey String   @default("clean")
  slug        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Section {
  id        String   @id @default(cuid())
  resumeId  String
  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  kind      String   // "experience" | "education" | "projects"
  heading   String
  items     Json     // array of { title, subtitle?, start?, end?, bullets?: string[] }
  order     Int
}
""")

# .env example
write(".env.example", """
# Copy to .env and fill
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/cv_platform?schema=public"
NEXT_PUBLIC_BASE_URL="http://localhost:3000"
""")

# docker-compose
write("docker-compose.yml", """
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: cv_platform
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
volumes:
  db_data:
""")

# lib/prisma.ts
write("src/lib/prisma.ts", """
import { PrismaClient } from "@prisma/client";

declare global {
  // eslint-disable-next-line no-var
  var prisma: PrismaClient | undefined;
}

export const prisma = global.prisma ?? new PrismaClient();
if (process.env.NODE_ENV !== "production") global.prisma = prisma;
""")

# types
write("src/types.ts", """
export type ResumeItem = {
  title: string;
  subtitle?: string;
  start?: string;
  end?: string;
  bullets?: string[];
};
export type ResumeSection = {
  kind: string;
  heading: string;
  items: ResumeItem[];
  order: number;
};
export type ResumePayload = {
  title: string;
  fullName: string;
  role?: string;
  summary?: string;
  phone?: string;
  email?: string;
  location?: string;
  skills: string[];
  sections: ResumeSection[];
  templateKey?: string;
  slug?: string;
};
""")

# app/layout.tsx
write("src/app/layout.tsx", """
import "./globals.css";
import { ReactNode } from "react";
export const metadata = {
  title: "CV Platform",
  description: "Build a professional resume in minutes"
};
export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="ar" dir="rtl">
      <body>
        <div className="containerish py-8">{children}</div>
      </body>
    </html>
  );
}
""")

# landing page
write("src/app/page.tsx", """
import Link from "next/link";

export default function Home() {
  return (
    <main className="space-y-8">
      <header className="text-center space-y-4">
        <h1 className="text-3xl md:text-5xl font-bold">منصّة سِيَر ذاتية احترافية</h1>
        <p className="text-white/70">أنشئ، عدّل، وصدّر سيرتك الذاتية PDF خلال دقائق.</p>
        <div className="flex items-center justify-center gap-3">
          <Link className="btn" href="/dashboard">ابدأ الآن</Link>
          <a className="link" href="https://github.com/" target="_blank" rel="noreferrer">الكود المصدري</a>
        </div>
      </header>
      <section className="grid md:grid-cols-2 gap-6">
        <div className="card space-y-3">
          <h2 className="text-xl font-semibold">محرّر مرن</h2>
          <p className="text-white/70">أقسام الخبرة، التعليم، المشاريع، والمهارات بواجهة بسيطة.</p>
        </div>
        <div className="card space-y-3">
          <h2 className="text-xl font-semibold">قوالب جاهزة</h2>
          <p className="text-white/70">اختر قالبًا نظيفًا عربي/إنجليزي مع دعم RTL.</p>
        </div>
      </section>
    </main>
  );
}
""")

# dashboard page
write("src/app/dashboard/page.tsx", """
import Link from "next/link";
import { prisma } from "@/src/lib/prisma";

export const dynamic = "force-dynamic";

export default async function Dashboard() {
  const resumes = await prisma.resume.findMany({ orderBy: { updatedAt: "desc" }});
  return (
    <main className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">لوحة التحكم</h1>
        <Link className="btn" href="/new">سيرة جديدة</Link>
      </div>
      <div className="grid md:grid-cols-2 gap-4">
        {resumes.map(r => (
          <div key={r.id} className="card">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-semibold">{r.title}</h3>
                <p className="text-white/60 text-sm">{r.fullName} • آخر تحديث: {new Date(r.updatedAt).toLocaleDateString("ar-SA")}</p>
              </div>
              <div className="flex gap-2">
                <Link className="btn" href={`/edit/${r.id}`}>تعديل</Link>
                <Link className="btn" href={`/r/${r.slug}`}>عرض</Link>
              </div>
            </div>
          </div>
        ))}
        {resumes.length === 0 && (
          <p className="text-white/70">لا توجد سير بعد — ابدأ بإنشاء أول سيرة.</p>
        )}
      </div>
    </main>
  );
}
""")

# new page
write("src/app/new/page.tsx", """
import ResumeForm from "@/src/components/ResumeForm";

export default function NewResume() {
  return (
    <main className="space-y-6">
      <h1 className="text-2xl font-bold">إنشاء سيرة ذاتية</h1>
      <ResumeForm />
    </main>
  );
}
""")

# edit page
write("src/app/edit/[id]/page.tsx", """
import { prisma } from "@/src/lib/prisma";
import ResumeForm from "@/src/components/ResumeForm";

export default async function EditResume({ params }: { params: { id: string }}) {
  const resume = await prisma.resume.findUnique({ where: { id: params.id }, include: { sections: true }});
  if (!resume) return <p className="text-white/70">غير موجود</p>;
  return (
    <main className="space-y-6">
      <h1 className="text-2xl font-bold">تعديل: {resume.title}</h1>
      <ResumeForm initial={{
        id: resume.id,
        title: resume.title,
        fullName: resume.fullName,
        role: resume.role ?? undefined,
        summary: resume.summary ?? undefined,
        phone: resume.phone ?? undefined,
        email: resume.email ?? undefined,
        location: resume.location ?? undefined,
        skills: resume.skills,
        sections: resume.sections.map(s => ({ kind: s.kind, heading: s.heading, items: s.items as any, order: s.order })),
        templateKey: resume.templateKey,
        slug: resume.slug
      }} />
    </main>
  );
}
""")

# public resume page
write("src/app/r/[slug]/page.tsx", """
import { prisma } from "@/src/lib/prisma";
import Link from "next/link";

export default async function PublicResume({ params }: { params: { slug: string }}) {
  const resume = await prisma.resume.findUnique({ where: { slug: params.slug }, include: { sections: { orderBy: { order: "asc" }}}});
  if (!resume) return <p className="text-white/70">غير موجود</p>;
  return (
    <main className="space-y-6 print:space-y-3">
      <header className="space-y-1 print:text-black">
        <h1 className="text-3xl font-bold">{resume.fullName}</h1>
        {resume.role && <p className="text-white/70">{resume.role}</p>}
        <p className="text-white/60 text-sm">{[resume.email, resume.phone, resume.location].filter(Boolean).join(" • ")}</p>
      </header>
      {resume.summary && (
        <section className="space-y-2">
          <h2 className="text-xl font-semibold">الملخص</h2>
          <p className="text-white/80">{resume.summary}</p>
        </section>
      )}
      {resume.sections.map(sec => (
        <section key={sec.id} className="space-y-2">
          <h3 className="text-lg font-semibold">{sec.heading}</h3>
          <ul className="space-y-2">
            {(sec.items as any[]).map((it, i) => (
              <li key={i}>
                <div className="flex items-center justify-between">
                  <span className="font-medium">{it.title}</span>
                  <span className="text-sm text-white/60">{[it.start, it.end].filter(Boolean).join(" - ")}</span>
                </div>
                {it.subtitle && <p className="text-white/70 text-sm">{it.subtitle}</p>}
                {it.bullets && (
                  <ul className="list-disc pr-5 text-sm text-white/80">
                    {it.bullets.map((b: string, j: number) => <li key={j}>{b}</li>)}
                  </ul>
                )}
              </li>
            ))}
          </ul>
        </section>
      ))}
      <div className="flex gap-2 no-print">
        <Link href={`/r/${resume.slug}/pdf`} className="btn">تحميل PDF</Link>
      </div>
    </main>
  );
}
""")

# PDF route using @react-pdf/renderer
write("src/app/r/[slug]/pdf/route.tsx", """
import { prisma } from "@/src/lib/prisma";
import { NextResponse } from "next/server";
import { Document, Page, Text, View, StyleSheet, Font, pdf } from "@react-pdf/renderer";

export async function GET(_: Request, { params }: { params: { slug: string }}) {
  const resume = await prisma.resume.findUnique({ where: { slug: params.slug }, include: { sections: { orderBy: { order: "asc" }}}});
  if (!resume) return new NextResponse("Not found", { status: 404 });

  const styles = StyleSheet.create({
    page: { padding: 32, fontSize: 11, fontFamily: "Helvetica" },
    h1: { fontSize: 20, marginBottom: 4 },
    muted: { color: "#666" },
    section: { marginTop: 12 },
    h2: { fontSize: 13, marginBottom: 4 }
  });

  const Doc = () => (
    <Document>
      <Page size="A4" style={styles.page}>
        <Text style={styles.h1}>{resume.fullName}</Text>
        {resume.role && <Text style={styles.muted}>{resume.role}</Text>}
        <Text style={styles.muted}>{[resume.email, resume.phone, resume.location].filter(Boolean).join(" • ")}</Text>
        {resume.summary && (
          <View style={styles.section}>
            <Text style={styles.h2}>الملخص</Text>
            <Text>{resume.summary}</Text>
          </View>
        )}
        {resume.sections.map((sec) => (
          <View key={sec.id} style={styles.section}>
            <Text style={styles.h2}>{sec.heading}</Text>
            {((sec.items as any[]) || []).map((it, i) => (
              <View key={i}>
                <Text>{it.title} {it.subtitle ? `• ${it.subtitle}` : ""}</Text>
                <Text style={styles.muted}>{[it.start, it.end].filter(Boolean).join(" - ")}</Text>
                {it.bullets && it.bullets.map((b: string, j: number) => <Text key={j}>• {b}</Text>)}
              </View>
            ))}
          </View>
        ))}
      </Page>
    </Document>
  );

  const blob = await pdf(<Doc />).toBuffer();
  return new NextResponse(blob, {
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="${resume.slug}.pdf"`
    }
  });
}
""")

# API routes
write("src/app/api/resumes/route.ts", """
import { prisma } from "@/src/lib/prisma";
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const slug = (body.slug || body.fullName).toString().trim().toLowerCase().replace(/\\s+/g, "-").slice(0, 64);
    const resume = await prisma.resume.create({
      data: {
        title: body.title,
        fullName: body.fullName,
        role: body.role,
        summary: body.summary,
        phone: body.phone,
        email: body.email,
        location: body.location,
        skills: body.skills || [],
        templateKey: body.templateKey || "clean",
        slug,
        sections: {
          create: (body.sections || []).map((s: any, idx: number) => ({
            kind: s.kind,
            heading: s.heading,
            items: s.items || [],
            order: s.order ?? idx
          }))
        }
      }
    });
    return NextResponse.json(resume);
  } catch (e: any) {
    return new NextResponse(e.message, { status: 400 });
  }
}

export async function GET() {
  const all = await prisma.resume.findMany({ include: { sections: true }, orderBy: { createdAt: "desc" } });
  return NextResponse.json(all);
}
""")

write("src/app/api/resumes/[id]/route.ts", """
import { prisma } from "@/src/lib/prisma";
import { NextResponse } from "next/server";

export async function GET(_: Request, { params }: { params: { id: string }}) {
  const resume = await prisma.resume.findUnique({ where: { id: params.id }, include: { sections: true } });
  if (!resume) return new NextResponse("Not found", { status: 404 });
  return NextResponse.json(resume);
}

export async function PUT(req: Request, { params }: { params: { id: string }}) {
  const body = await req.json();
  // Update resume basic fields
  await prisma.resume.update({
    where: { id: params.id },
    data: {
      title: body.title,
      fullName: body.fullName,
      role: body.role,
      summary: body.summary,
      phone: body.phone,
      email: body.email,
      location: body.location,
      skills: body.skills || [],
      templateKey: body.templateKey || "clean",
      slug: body.slug
    }
  });
  // Replace sections (simpler for MVP)
  await prisma.section.deleteMany({ where: { resumeId: params.id } });
  if (body.sections?.length) {
    await prisma.section.createMany({
      data: body.sections.map((s: any, idx: number) => ({
        resumeId: params.id,
        kind: s.kind,
        heading: s.heading,
        items: s.items || [],
        order: s.order ?? idx
      }))
    });
  }
  const updated = await prisma.resume.findUnique({ where: { id: params.id }, include: { sections: true } });
  return NextResponse.json(updated);
}

export async function DELETE(_: Request, { params }: { params: { id: string }}) {
  await prisma.resume.delete({ where: { id: params.id } });
  return new NextResponse(null, { status: 204 });
}
""")

# components/ResumeForm
write("src/components/ResumeForm.tsx", """
"use client";

import { useForm, useFieldArray } from "react-hook-form";
import { useState, useTransition } from "react";
import { ResumePayload } from "@/src/types";
import { useRouter } from "next/navigation";

const defaultData: ResumePayload = {
  title: "سيرتي الذاتية",
  fullName: "فلان الفلاني",
  role: "مسؤول دعم فني",
  summary: "ملخص قصير عن خبراتك ومهاراتك.",
  phone: "",
  email: "",
  location: "الرياض، السعودية",
  skills: ["الدعم الفني", "حل المشاكل", "Windows", "Networking"],
  sections: [
    {
      kind: "experience",
      heading: "الخبرات",
      order: 0,
      items: [{
        title: "فني دعم - شركة ABC",
        subtitle: "دوام كامل",
        start: "2022",
        end: "حتى الآن",
        bullets: ["حل 50+ تذكرة شهريًا", "تحسين رضا العملاء 20%"]
      }]
    },
    {
      kind: "education",
      heading: "التعليم",
      order: 1,
      items: [{
        title: "دبلوم دعم فني",
        subtitle: "الكلية التقنية بالرياض",
        start: "2019",
        end: "2022"
      }]
    }
  ],
  templateKey: "clean",
  slug: "cv-demo"
};

export default function ResumeForm({ initial }: { initial?: Partial<ResumePayload & { id: string }>}) {
  const router = useRouter();
  const [pending, startTransition] = useTransition();
  const { register, handleSubmit, control, watch } = useForm<ResumePayload>({
    defaultValues: initial ? (initial as any) : defaultData
  });
  const { fields: sectionFields, append, remove } = useFieldArray({ control, name: "sections" as const });

  async function onSubmit(data: ResumePayload) {
    const method = initial?.id ? "PUT" : "POST";
    const url = initial?.id ? `/api/resumes/${initial.id}` : "/api/resumes`";
    const realUrl = initial?.id ? `/api/resumes/${initial.id}` : "/api/resumes";
    startTransition(async () => {
      const res = await fetch(realUrl, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
      if (!res.ok) { alert("حدث خطأ"); return; }
      const json = await res.json();
      router.push(`/edit/${json.id}`);
      router.refresh();
    });
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="grid md:grid-cols-2 gap-4">
        <div className="card space-y-2">
          <label className="label">عنوان السيرة</label>
          <input className="input" {...register("title")} />
          <label className="label">الاسم الكامل</label>
          <input className="input" {...register("fullName")} />
          <label className="label">المسمى الوظيفي</label>
          <input className="input" {...register("role")} />
          <label className="label">الملخص</label>
          <textarea className="input" rows={4} {...register("summary")} />
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="label">البريد</label>
              <input className="input" {...register("email")} />
            </div>
            <div>
              <label className="label">الهاتف</label>
              <input className="input" {...register("phone")} />
            </div>
          </div>
          <label className="label">الموقع</label>
          <input className="input" {...register("location")} />
          <label className="label">المهارات (افصل بفاصلة)</label>
          <input className="input" {...register("skills", { setValueAs: (v) => typeof v === "string" ? v.split(",").map((s: string) => s.trim()).filter(Boolean) : v })} />
          <label className="label">الرابط (slug)</label>
          <input className="input" {...register("slug")} />
        </div>

        <div className="space-y-4">
          {sectionFields.map((sec, idx) => (
            <div key={sec.id} className="card space-y-2">
              <div className="flex items-center justify-between">
                <h3 className="font-semibold">قسم #{idx + 1}</h3>
                <button type="button" className="btn" onClick={() => remove(idx)}>حذف</button>
              </div>
              <label className="label">العنوان</label>
              <input className="input" {...register(`sections.${idx}.heading` as const)} />
              <label className="label">النوع</label>
              <input className="input" placeholder="experience / education / projects" {...register(`sections.${idx}.kind` as const)} />
              <label className="label">الترتيب</label>
              <input className="input" type="number" {...register(`sections.${idx}.order` as const, { valueAsNumber: true })} />
              <ItemsEditor namePrefix={`sections.${idx}.items`} control={control as any} register={register as any} />
            </div>
          ))}
          <button type="button" className="btn" onClick={() => append({ kind: "custom", heading: "قسم جديد", order: sectionFields.length, items: [] as any })}>
            + إضافة قسم
          </button>
        </div>
      </div>

      <div className="flex gap-3">
        <button className="btn" type="submit" disabled={pending}>{initial?.id ? "حفظ التعديلات" : "إنشاء السيرة"}</button>
      </div>
    </form>
  );
}

function ItemsEditor({ namePrefix, control, register }: any) {
  const { fields, append, remove } = useFieldArray({ control, name: namePrefix });
  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <h4 className="font-medium">العناصر</h4>
        <button type="button" className="btn" onClick={() => append({ title: "المسمى", subtitle: "", start: "", end: "", bullets: [] })}>+ عنصر</button>
      </div>
      {fields.map((f: any, i: number) => (
        <div key={f.id} className="rounded-lg border border-white/10 p-3 space-y-2">
          <label className="label">العنوان</label>
          <input className="input" {...register(`${namePrefix}.${i}.title`)} />
          <label className="label">وصف قصير</label>
          <input className="input" {...register(`${namePrefix}.${i}.subtitle`)} />
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="label">من</label>
              <input className="input" {...register(`${namePrefix}.${i}.start`)} />
            </div>
            <div>
              <label className="label">إلى</label>
              <input className="input" {...register(`${namePrefix}.${i}.end`)} />
            </div>
          </div>
          <label className="label">نقاط (افصل بفاصلة)</label>
          <input className="input" {...register(`${namePrefix}.${i}.bullets`, { setValueAs: (v: any) => typeof v === "string" ? v.split(",").map((s: string) => s.trim()).filter(Boolean) : v })} />
          <div className="flex justify-end">
            <button type="button" className="btn" onClick={() => remove(i)}>حذف العنصر</button>
          </div>
        </div>
      ))}
    </div>
  );
}
""")

# simple route for /r/[slug] not found edge case is covered.

# README
write("README.md", """
# CV Platform (Next.js + Prisma + Postgres)

منصّة جاهزة لإنشاء سِيَر ذاتية احترافية بالعربية/الإنجليزية (RTL)، مع تصدير PDF.

## التقنيات
- Next.js (App Router)
- Prisma + PostgreSQL
- TailwindCSS
- @react-pdf/renderer لتوليد PDF
- Docker Compose لقاعدة البيانات

## التشغيل محليًا
```bash
# 1) انسخ المتغيرات
cp .env.example .env

# 2) شغّل قاعدة البيانات
docker compose up -d

# 3) ثبّت الاعتماديات
npm i

# 4) أنشئ الجداول
npx prisma migrate dev --name init

# 5) شغّل التطوير
npm run dev
